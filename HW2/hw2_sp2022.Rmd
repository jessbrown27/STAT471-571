---
title: "Modern Data Mining, HW 2"
author:
- Jessica Brown
- Sarah Hayward
- Annie Vo
date: 'Due: 11:59 PM,  Sunday, 02/13'
output:
  pdf_document:
    number_sections: yes
    toc: yes
    toc_depth: '4'
  html_document:
    code_folding: show
    highlight: haddock
    number_sections: yes
    theme: lumen
    toc: yes
    toc_depth: 4
    toc_float: yes
  word_document:
    toc: yes
    toc_depth: '4'
urlcolor: blue
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.width=8, fig.height=4)
options(scipen = 0, digits = 3)  # controls base R output
# check if you have ISLR package, if not, install it
if(!require('pacman')) {install.packages('pacman')}
pacman::p_load(ISLR, tidyverse, data.table) # add the packages needed
```


\pagebreak

# Overview {-}

Principle Component Analysis is widely used in data exploration, dimension reduction, data visualization. The aim is to transform original data into uncorrelated linear combinations of the original data while keeping the information contained in the data. High dimensional data tends to show clusters in lower dimensional view. 

Clustering Analysis is another form of EDA. Here we are hoping to group data points which are close to each other within the groups and far away between different groups. Clustering using PC's can be effective. Clustering analysis can be very subjective in the way we need to summarize the properties within each group. 

Both PCA and Clustering Analysis are so called unsupervised learning. There is no response variables involved in the process. 

For supervised learning, we try to find out how does a set of predictors relate to some response variable of the interest. Multiple regression is still by far, one of the most popular methods. We use linear models as a working model for its simplicity and interpretability. It is important that we use domain knowledge as much as we can to determine the form of the response as well as the function format of the factors.


## Objectives

- PCA
- SVD
- Clustering Analysis
- Linear Regression

## Review materials

- Study Module 2: PCA
- Study Module 3: Clustering Analysis
- Study Module 4: Multiple regression

## Data needed

- `NLSY79.csv`
- `brca_subtype.csv`
- `brca_x_patient.csv`

# Case study 1: Self-seteem 

Self-esteem generally describes a person's overall sense of self-worthiness and personal value. It can play significant role in one's motivation and success throughout the life. Factors that influence self-esteem can be inner thinking, health condition, age, life experiences etc. We will try to identify possible factors in our data that are related to the level of self-esteem. 

In the well-cited National Longitudinal Study of Youth (NLSY79), it follows about 13,000 individuals and numerous individual-year information has been gathered through surveys. The survey data is open to public [here](https://www.nlsinfo.org/investigator/). Among many variables we assembled a subset of variables including personal demographic variables in different years, household environment in 79, ASVAB test Scores in 81 and Self-Esteem scores in 81 and 87 respectively. 

The data is store in `NLSY79.csv`.

Here are the description of variables:

**Personal Demographic Variables**

* Gender: a factor with levels "female" and "male"
* Education05: years of education completed by 2005
* HeightFeet05, HeightInch05: height measurement. For example, a person of 5'10 will be recorded as HeightFeet05=5, HeightInch05=10.
* Weight05: weight in lbs.
* Income87, Income05: total annual income from wages and salary in 2005. 
* Job87, Job05: job type in 1987 and 2005, including Protective Service Occupations, Food Preparation and Serving Related Occupations, Cleaning and Building Service Occupations, Entertainment Attendants and Related Workers, Funeral Related Occupations, Personal Care and Service Workers, Sales and Related Workers, Office and Administrative Support Workers, Farming, Fishing and Forestry Occupations, Construction Trade and Extraction Workers, Installation, Maintenance and Repairs Workers, Production and Operating Workers, Food Preparation Occupations, Setters, Operators and Tenders,  Transportation and Material Moving Workers
 
 
**Household Environment**
 
* Imagazine: a variable taking on the value 1 if anyone in the respondent’s household regularly read magazines in 1979, otherwise 0
* Inewspaper: a variable taking on the value 1 if anyone in the respondent’s household regularly read newspapers in 1979, otherwise 0
* Ilibrary: a variable taking on the value 1 if anyone in the respondent’s household had a library card in 1979, otherwise 0
* MotherEd: mother’s years of education
* FatherEd: father’s years of education
* FamilyIncome78

**Variables Related to ASVAB test Scores in 1981**

Test | Description
--------- | ------------------------------------------------------
AFQT | percentile score on the AFQT intelligence test in 1981 
Coding | score on the Coding Speed test in 1981
Auto | score on the Automotive and Shop test in 1981
Mechanic | score on the Mechanic test in 1981
Elec | score on the Electronics Information test in 1981
Science | score on the General Science test in 1981
Math | score on the Math test in 1981
Arith | score on the Arithmetic Reasoning test in 1981
Word | score on the Word Knowledge Test in 1981
Parag | score on the Paragraph Comprehension test in 1981
Numer | score on the Numerical Operations test in 1981

**Self-Esteem test 81 and 87**

We have two sets of self-esteem test, one in 1981 and the other in 1987. Each set has same 10 questions. 
They are labeled as `Esteem81` and `Esteem87` respectively followed by the question number.
For example, `Esteem81_1` is Esteem question 1 in 81.

The following 10 questions are answered as 1: strongly agree, 2: agree, 3: disagree, 4: strongly disagree

* Esteem 1: “I am a person of worth”
* Esteem 2: “I have a number of good qualities”
* Esteem 3: “I am inclined to feel like a failure”
* Esteem 4: “I do things as well as others”
* Esteem 5: “I do not have much to be proud of”
* Esteem 6: “I take a positive attitude towards myself and others”
* Esteem 7: “I am satisfied with myself”
* Esteem 8: “I wish I could have more respect for myself”
* Esteem 9: “I feel useless at times”
* Esteem 10: “I think I am no good at all”

## Data preparation

Load the data. Do a quick EDA to get familiar with the data set. Pay attention to the unit of each variable. Are there any missing values?


## Self esteem evaluation

Let concentrate on Esteem scores evaluated in 87. 

1. Reverse Esteem 1, 2, 4, 6, and 7 so that a higher score corresponds to higher self-esteem. (Hint: if we store the esteem data in `data.esteem`, then `data.esteem[,  c(1, 2, 4, 6, 7)]  <- 5 - data.esteem[,  c(1, 2, 4, 6, 7)]` to reverse the score.)
```{R}
esteem87 <- esteem_data[,  c(37:46)]
esteem87_transformed <- esteem87
esteem87_transformed[,  c(1, 2, 4, 6, 7)] <- 5 - esteem87_transformed[,  c(1, 2, 4, 6, 7)]
esteem87
esteem87_transformed
```

2. Write a brief summary with necessary plots about the 10 esteem measurements.

```{R}
ggplot(gather(esteem87_transformed), aes(value)) + 
    geom_histogram(bins = 4) + 
    facet_wrap(~key, scales = 'free_x')
```

**Answer:** A majority of the responses for all the esteem measurements fall on the higher end (3 or 4). However there are esteem measurements that have higher counts of 4s (1, 2, 3, and 5), relatively equal counts of 3s and 4s as the majority (4, 6, and 10), and ones that have a higher count of 3s (7, 8, and 9).

3. Do esteem scores all positively correlated? Report the pairwise correlation table and write a brief summary.

```{R}
pairs(esteem87_transformed, xlim=c(1, 4), ylim=c(1, 4), pch=16)
cor(esteem87_transformed)
```

**Answer:** The esteem scores are all positively correlated with each other. Esteem 1 and 2 have the strongest pairwise correlation with an r of 0.704. Esteem score 8 seems to have the weakest correlation with the other esteems with none of the r values being above 0.5. Esteem score 7 and 9 is also on the weaker side. The esteem scores that have a similar histogram as in part 2 have a stronger correlation while having a weeker correlation with histograms that differ in shape. 

4. PCA on 10 esteem measurements. (centered but no scaling)

```{R}
esteem_pc <- prcomp(esteem87_transformed, scale=TRUE)
esteem_pc
```

    a) Report the PC1 and PC2 loadings. Are they unit vectors? Are they orthogonal?
    
    ```{R}
    esteem_pc$rotation[, c(1, 2)]
    ```
    
    By definition, all loadings are unit 1 so they are unit vectors and they are all perpendicular.
    
    b) Are there good interpretations for PC1 and PC2? (If loadings are all negative, take the positive loadings for the ease of interpretation)
    
    PC1 is the weighted sum of the scores and also shows which are more strongly correlated with each other. The loadings for esteem score 8 and 9 align with the answer in question 3 that they have a weaker correlation. Esteem score 2 and 6 seem to have the stronger ones. PC2 shows the difference of the esteems, as some increase (esteem 3, 5, 7, 8, 9, 10), the others decrease (esteem 1, 2, 4, 6) and vice versa. 
    
    c) How is the PC1 score obtained for each subject? Write down the formula.
    
    The PC1 score is obtained by multiplying the actual values by the loadings. In this case it would be: Esteem87_1 * 0.324 + Esteem87_2 * 0.333 + Esteem87_3 * 0.322 + Esteem87_4 * 0.324 + Esteem87_5 * 0.315 + Esteem87_6 * 0.347 + Esteem87_7 * 0.315 + Esteem87_8 * 0.280 + Esteem87_9 * 0.277 + Esteem87_10 * 0.318
    
    d) Are PC1 scores and PC2 scores in the data uncorrelated?
    
    All PC scores are uncorrelated.
    
    e) Plot PVE (Proportion of Variance Explained) and summarize the plot.
    
    ```{R}
    summary(esteem_pc)$importance
    plot(esteem_pc)
    plot(summary(esteem_pc)$importance[2, ],  # PVE
     ylab="PVE",
     xlab="Number of PC's",
     pch = 16, 
     main="Scree Plot of PVE for Esteem")
    ```
    
    The plot has a steep drop at 2 PCs so that indicates that 2 leading PCs should be enough for most purposes since a large portion of the variances can be explained by those 2. At 1 PC, there is nearly a 0.5 PVE then the chart drops when at 2 PCs to a bit above 0.1 PVE. After the second PC, the PVE levels out a bit.
  
    f) Also plot CPVE (Cumulative Proportion of Variance Explained). What proportion of the variance in the data is explained by the first two principal components?
    
    ```{R}
    plot(summary(esteem_pc)$importance[3, ], pch=16,
     ylab="Cumulative PVE",
     xlab="Number of PC's",
     main="Scree Plot of Cumulative PVE for Esteem")
    ```
    
    About 0.6 of the variance in the data is explained by the first two principal components.
  
    g) PC’s provide us with a low dimensional view of the self-esteem scores. Use a biplot with the first two PC's to display the data.  Give an interpretation of PC1 and PC2 from the plot. (try `ggbiplot` if you could, much prettier!)
    
    ```{R}
    biplot(esteem_pc, cex=0.5, xlim=c(-.03, .03),
       ylim=c(-.03, .03),
       main="Biplot for first 2 PCs")
    abline(h=0, v=0, col="red", lwd=2)
    ```
    
    Loadings for PC1 are similar in magnitudes and with same signs. PC2 captures the difference of total of esteem 3, 5, 7, 8, 9, 10 and total of esteem 1, 2, 4, 6. Esteem 1 and 2 are highly correlated with each other. 3 and 7 are also highly coorelated, as well as 8 and 10.

5. Apply k-means to cluster subjects on the original esteem scores

    a) Find a reasonable number of clusters using within sum of squared with elbow rules.
    
    ```{R}
    #install.packages("factoextra")
    #library(factoextra)
    set.seed(0)
    fviz_nbclust(esteem87[,-1], kmeans, method = "wss")
    ```
    
    There is a bend at number of clusters = 2 so a reasonable number of clusters to use is 2.
    
    b) Can you summarize common features within each cluster?
    
    ```{R}
    esteem_kmeans <- kmeans(esteem87, centers = 2 )
    str(esteem_kmeans)
    esteem_kmeans$centers
    ```
    
    From looking at the centers for the two clusters, the first cluster has more extreme scores (either closer to 1 or 4). Meanwhile the second cluster has more mild scores (closer to the middle range of scores (2 and 3)).
    
    c) Can you visualize the clusters with somewhat clear boundaries? You may try different pairs of variables and different PC pairs of the esteem scores.
    
    ```{R}
    data.frame(
        education = esteem_data$Education05,
        AFQT = esteem_data$AFQT,   
        group = as.factor(esteem_kmeans$cluster)) %>%
    ggplot(aes(x = education, y = AFQT, col = group)) +
    geom_point() +
    ggtitle("Clustering over education in 2005 and AFQT in 1981")
    
    data.frame(
        income = esteem_data$Income05,
        family_income = esteem_data$FamilyIncome78,   
        group = as.factor(esteem_kmeans$cluster)) %>%
    ggplot(aes(x = income, y = family_income, col = group)) +
    geom_point() +
    ggtitle("Clustering over income in 2005 and family income in 1978")
    
    data.frame(
        weight = esteem_data$Weight05,
        height = esteem_data$HeightFeet05 * 12 + esteem_data$HeightInch05,   
        group = as.factor(esteem_kmeans$cluster)) %>%
    ggplot(aes(x = weight, y = height, col = group)) +
    geom_point() +
    ggtitle("Clustering over weight and height in 2005")
    
    data.frame(
        pc1 = esteem_pc$x[, 1], 
        pc2 = esteem_pc$x[, 2],
        group = as.factor(esteem_kmeans$cluster)) %>%
    ggplot(aes(x = pc1, y = pc2, col = group)) +
    geom_point() +
    ggtitle("Clustering over PC1 and PC2")
    ```
    
    For education and AFQT, there is not much of a clear boundry on the clusters. However, a majority of the people with education less than 10 does seem to fall under the second cluster. When looking at income and family income, there is a larger clump of cluster 2 wiht a lower income and family income. There does not seem to be any clear boundaries with the clusters when looking at height and weight. When looking at PC1, there is a clear separation between the two clusters. Points with a negative PC1 are largely in cluster 2 while positive PC1s are largely cluster 1.

6. We now try to find out what factors are related to self-esteem? PC1 of all the Esteem scores is a good variable to summarize one's esteem scores. We take PC1 as our response variable.

    a) Prepare possible factors/variables:

      - Personal information: gender, education (05, problematic), log(income) in 87, job type in 87, Body mass index as a measure of health (The BMI is defined as the body mass divided by the square of the body height, and is universally expressed in units of kg/m²). Since BMI is measured in 05, this will not be a good practice to be inclueded as possible variables.
          
      - Household environment: Imagazine, Inewspaper, Ilibrary, MotherEd, FatherEd, FamilyIncome78. Do set indicators `Imagazine`, `Inewspaper` and `Ilibrary` as factors. 
    
      - Use PC1 of SVABS as level of intelligence

```{R}
#create a BMI variable
esteem_data <- esteem_data %>% mutate(BMI = ((Weight05 / 2.205) / ((HeightFeet05 * 12 + HeightInch05) / 39.37)^2))

#create a PC1 variable
esteem_data <- esteem_data %>% mutate(PC1 = Esteem87_1 * 0.324 + Esteem87_2 * 0.333 + Esteem87_3 * 0.322 + Esteem87_4 * 0.324 + Esteem87_5 * 0.315 + Esteem87_6 * 0.347 + Esteem87_7 * 0.315 + Esteem87_8 * 0.280 + Esteem87_9 * 0.277 + Esteem87_10 * 0.318)

#select the variables of interest
esteem_prepared <- esteem_data[,c('Gender','Education05','Income87', 'Job05', 'BMI', 'Imagazine', 'Inewspaper',
                                  'Ilibrary', 'MotherEd', 'FatherEd', 'FamilyIncome78', 'PC1')]

summary(esteem_prepared$Income87) #there are some values less than 0 so taking log would be problematic for those cases
#set all negative income values to 0
esteem_prepared <- esteem_prepared %>% mutate(Income87 = ifelse(Income87 < 0, 0, Income87))
#log transformation for income, add one so log of 0 will not give an error
esteem_prepared <- esteem_prepared %>% mutate(LogIncome87 = log(Income87 + 1))

#doing the same log transformation with FamilyIncome78 to be consistent with units as Income87
summary(esteem_prepared$FamilyIncome78) #no negative values
#log transformation for family income, add one so log of 0 will not give an error
esteem_prepared <- esteem_prepared %>% mutate(LogFamilyIncome78 = log(FamilyIncome78 + 1))

#changing Imagazine, Inewspaper, and Ilibrary to factors
esteem_prepared <- esteem_prepared %>% mutate(Imagazine = as.factor(Imagazine), Inewspaper = as.factor(Inewspaper), Ilibrary = as.factor(Ilibrary))
```
        
    b)   Run a few regression models between PC1 of all the esteem scores and suitable variables listed in a). Find a final best model with your own criterion. 

      - How did you land this model? Run a model diagnosis to see if the linear model assumptions are reasonably met. 
        
      - Write a summary of your findings. In particular, explain what and how the variables in the model affect one's self-esteem. 
        
```{R}
#after running the graphs with the 0s, we saw there was some skewness with the 0 values so we decided to also run everything excluding the 0 income values
esteem_prepared_remove0 <- esteem_prepared %>% filter(LogIncome87 != 0, LogFamilyIncome78 != 0)

ggplot(esteem_prepared, aes(x = Gender , y = PC1)) + 
  geom_boxplot()

ggplot(esteem_prepared, aes(x = Education05 , y = PC1)) + 
  geom_point() +
  geom_smooth(method="lm",se=F)

ggplot(esteem_prepared, aes(x = LogIncome87 , y = PC1)) + 
  geom_point() +
  geom_smooth(method="lm",se=F)

ggplot(esteem_prepared_remove0, aes(x = LogIncome87 , y = PC1)) + 
  geom_point() +
  geom_smooth(method="lm",se=F)

ggplot(esteem_prepared, aes(x = Job05 , y = PC1)) + 
  geom_boxplot()

ggplot(esteem_prepared, aes(x = BMI , y = PC1)) + 
  geom_point() +
  geom_smooth(method="lm",se=F)

ggplot(esteem_prepared, aes(x = Imagazine , y = PC1)) + 
  geom_boxplot()

ggplot(esteem_prepared, aes(x = Inewspaper , y = PC1)) + 
  geom_boxplot()

ggplot(esteem_prepared, aes(x = Ilibrary , y = PC1)) + 
  geom_boxplot()

ggplot(esteem_prepared, aes(x = MotherEd , y = PC1)) + 
  geom_point() +
  geom_smooth(method="lm",se=F)

ggplot(esteem_prepared, aes(x = FatherEd , y = PC1)) + 
  geom_point() +
  geom_smooth(method="lm",se=F)

ggplot(esteem_prepared, aes(x = LogFamilyIncome78 , y = PC1)) + 
  geom_point() +
  geom_smooth(method="lm",se=F)

ggplot(esteem_prepared_remove0, aes(x = LogFamilyIncome78 , y = PC1)) + 
  geom_point() +
  geom_smooth(method="lm",se=F)

#running regression tests with all the variables to see if there are variables that are more significant than others
esteem_regression <- lm(PC1 ~ Education05 + LogIncome87 + BMI + Imagazine + Inewspaper + Ilibrary + MotherEd + FatherEd + LogFamilyIncome78, data = esteem_prepared)
summary(esteem_regression)

#running regression tests with all the variables to see if there are variables that are more significant than others leaving out 0 income values
esteem_regression_remove0 <- lm(PC1 ~ Education05 + LogIncome87 + BMI + Imagazine + Inewspaper + Ilibrary + MotherEd + FatherEd + LogFamilyIncome78, data = esteem_prepared_remove0)
summary(esteem_regression_remove0)

#from the past regression tests, running one with variables with a lower p value.
esteem_regression_remove0_limited <- lm(PC1 ~ LogIncome87 + Imagazine + LogFamilyIncome78, data = esteem_prepared_remove0)
summary(esteem_regression_remove0_limited)

#model diagnosis to see if the linear model assumptions are met
par(mfrow=c(1,2))
plot(esteem_regression_remove0_limited, 1) 
plot(esteem_regression_remove0_limited, 2) 
```
    **Answer:** Our final model is PC1 = 6.6764 + 0.0598 * LogIncome87 + 0.0492 * Imagazine + 0.0281 * LogFamilyIncome78. To come to this model, we picked out the variables with stronger correlations when running the regression models between PC1 and all of the esteem scores. We also ran regression tests with all the variables and picked out ones that had a more significant p value. From the Residuals vs Fitted and qqnormal Plot, the linear model assumptions are reasonably met. Overall, we found that LogIncome87 had the strongest positive correlation with self-esteem, then Imagazine, and then LogFamilyIncome78 should everything else be held constant. In other words, someone in a household where someone regularly reads magazines and with a higher personal and family income tends to have a higher self-esteem.


# Case study 2: Breast cancer sub-type


[The Cancer Genome Atlas (TCGA)](https://www.cancer.gov/about-nci/organization/ccg/research/structural-genomics/tcga), a landmark cancer genomics program by National Cancer Institute (NCI), molecularly characterized over 20,000 primary cancer and matched normal samples spanning 33 cancer types. The genome data is open to public from the [Genomic Data Commons Data Portal (GDC)](https://portal.gdc.cancer.gov/).
 
In this study, we focus on 4 sub-types of breast cancer (BRCA): basal-like (basal), Luminal A-like (lumA), Luminal B-like (lumB), HER2-enriched. The sub-type is based on PAM50, a clinical-grade luminal-basal classifier. 

* Luminal A cancers are low-grade, tend to grow slowly and have the best prognosis.
* Luminal B cancers generally grow slightly faster than luminal A cancers and their prognosis is slightly worse.
* HER2-enriched cancers tend to grow faster than luminal cancers and can have a worse prognosis, but they are often successfully treated with targeted therapies aimed at the HER2 protein. 
* Basal-like breast cancers or triple negative breast cancers do not have the three receptors that the other sub-types have so have fewer treatment options.

We will try to use mRNA expression data alone without the labels to classify 4 sub-types. Classification without labels or prediction without outcomes is called unsupervised learning. We will use K-means and spectrum clustering to cluster the mRNA data and see whether the sub-type can be separated through mRNA data.

We first read the data using `data.table::fread()` which is a faster way to read in big data than `read.csv()`. 

```{r}
brca <- fread("data/brca_subtype.csv")

# get the sub-type information
brca_subtype <- brca$BRCA_Subtype_PAM50
brca <- brca[,-1]
```

1. Summary and transformation

    a) How many patients are there in each sub-type? 
    
```{r}
table(brca_subtype)
```
This table shows the amount of patients in each subtype. 

    b) Randomly pick 5 genes and plot the histogram by each sub-type.
```{r}
#randomly select 5 genes
set.seed(5)
sample_idx <- sample(ncol(brca), 5)

#plot histogram
brca %>% 
  select(all_of(sample_idx)) %>% # select column by index
  mutate(subtype = brca_subtype) %>%
  pivot_longer(cols = !starts_with("subtype"), values_to = "value") %>% # for facet(0)
  ggplot(aes(x = value, y = ..density..)) +
  geom_histogram(aes(fill = name)) +
  facet_wrap(subtype ~ name, scales = "free") +
  theme_bw() +
  theme(legend.position = "none")
```
    

    c) Remove gene with zero count and no variability. Then apply logarithmic transform.
```{r}
library("matrixStats")
keep_cols <- which(colSums(abs(brca)) != 0 & colSds(as.matrix(brca)) > 0.0001)
brca_sub <- brca[, keep_cols, with = F]

#log 
brca_sub <- log2(as.matrix(brca_sub+1e-10))
```


2. Apply kmeans on the transformed dataset with 4 centers and output the discrepancy table between the real sub-type `brca_subtype` and the cluster labels.

```{r}
brca_sub_kmeans <- kmeans(x = brca_sub, 4)
```

```{r}
#output discrepancy table
table(brca_subtype, brca_sub_kmeans$cluster)
```


3. Spectrum clustering: to scale or not to scale?

    a) Apply PCA on the centered and scaled dataset. How many PCs should we use and why? You are encouraged to use `irlba::irlba()`.
```{r}
brca_sub_scaled <- scale(as.matrix(brca_sub), center = T, scale = T)
svd_ret <- irlba::irlba(brca_sub_scaled, nv = 10, center = colMeans(brca_sub_scaled))

#plot the PVE
svd_var <- svd_ret$d^2 / (nrow(brca_sub_scaled) - 1)
pve_apx <- svd_var / ncol(brca)
plot(pve_apx, type="b", pch = 19, frame = FALSE)
```
We should use 4 PCs given that it is the elbow of the graph of the approximated proportion of variance explained. Essentially, until PC4, there are more dramatic increases in PVE and it starts leveling out after that. 
    
    b) Plot PC1 vs PC2 of the centered and scaled data and PC1 vs PC2 of the centered but unscaled data side by side. Should we scale or not scale for clustering propose? Why? (Hint: to put plots side by side, use `gridExtra::grid.arrange()` or `ggpubr::ggrrange()` or `egg::ggrrange()` for ggplots; use `fig.show="hold"` as chunk option for base plots)
```{r}
set.seed(10)
pc_score_scaled <- brca_sub_scaled %*% svd_ret$v[, 1:2]

brca_sub_unscaled <- scale(as.matrix(brca_sub), center = T, scale = F)
svd_ret_unscaled <- irlba::irlba(brca_sub_unscaled, nv = 10, center = colMeans(brca_sub_scaled))
pc_score_unscaled <- brca_sub_unscaled %*% svd_ret_unscaled$v[, 1:2]

plot1 <- data.table(x = pc_score_scaled[,1],
         y = pc_score_scaled[,2]) %>% ggplot() + 
         geom_point(aes(x = x, y = y))

plot2 <- data.table(x = pc_score_unscaled[,1],
         y = pc_score_unscaled[,2]) %>% ggplot() + 
         geom_point(aes(x = x, y = y))

gridExtra::grid.arrange(plot1, plot2, ncol = 2)
```
From these plots, the unscaled data actually seems to be better for clustering, as the data in the scaled plot is much more similar and it seems harder to distinguish groups from the data. Meanwhile, in the unscaled graph we can easily see 2 groups and the data would be easier to split into clusters. 

4. Spectrum clustering: center but do not scale the data

    a) Use the first 4 PCs of the centered and unscaled data and apply kmeans. Find a reasonable number of clusters using within sum of squared with the elbow rule.
```{r}
library(factoextra)

pc_score_spectrum <- brca_sub_unscaled %*% svd_ret_unscaled$v[, 1:4]

fviz_nbclust(pc_score_spectrum, kmeans, method = "wss")
```
Using the elbow rule, we can reasonably decide on k = 3 or 4, but given the context of this case, we'll use 4 clusters.

    b) Choose an optimal cluster number and apply kmeans. Compare the real sub-type and the clustering label as follows: Plot scatter plot of PC1 vs PC2. Use point color to indicate the true cancer type and point shape to indicate the clustering label. Plot the kmeans centroids with black dots. Summarize how good is clustering results compared to the real sub-type.
    
```{r fig.height= 4, fig.width=5}
set.seed(4)
kmean_ret <- kmeans(x = pc_score_spectrum, 4)

kmeans_table <- data.table(x = pc_score_spectrum[, 1],
  y = pc_score_spectrum[, 2],
  col = as.factor(brca_subtype),
  cl = as.factor(kmean_ret$cluster))

kmeans_plot <- ggplot() +
  geom_point(data = kmeans_table, mapping = aes(x = x, y = y, col = col, shape = cl)) +
  scale_color_manual(labels = c("basal", "Her2", "lumA", "lumB"),
  values = scales::hue_pal()(4)) +
  scale_shape_manual(labels = c("Clulster 1", "Cluster 2", "Cluster 3", "Cluster 4"),
  values = c(4, 16, 6, 5)) +
  geom_point(mapping = aes_string(x = kmean_ret$centers[, 1], y = kmean_ret$centers[, 2]), color = "black", size = 3) + 
  theme_bw() +
  labs(color = "Cancer type", shape = "Cluster") +
  xlab("PC1") +
  ylab("PC2")

kmeans_plot
```
Our results are pretty good for some subtypes of cancer. We can see that Cluster 3 in particular is a great fit for basal, as it is the group we observed earlier which we noticed was most separate from the rest of the data. We can also see that although there are many lumA datapoints, Cluster 1 almost entirely consists of them. For lumB, we can see that most of the points are in Cluster 2. HER-2 cancers seem to be the one category that is unable to be captured at all by our clusters. These data points are so spread out and it lead to Cluster 4 capturing a wide variety of subtypes instead. 
    
    c) Compare the clustering result from applying kmeans to the original data and the clustering result from applying kmeans to 4 PCs. Does PCA help in kmeans clustering? What might be the reasons if PCA helps?
    
We can compare the discrepancy tables for the original data and after applying kmeans to the 4PCs. 
```{r}
#original 
table(brca_subtype, brca_sub_kmeans$cluster)
```

```{r}
#with PCA
table(brca_subtype, kmean_ret$cluster)
```
From these tables, we see similar performance with grouping the basal subtype, although some of the others seemingly performing worse with PCA. Particularly, Her-2 still performs pretty bad under both clustering, but is noticably more spread out amongst the clusters with PCA. LumA also still has a high concentration in one cluster, but noticably less points in that cluster with PCA with more in other clusters. The only subtype that seems to do marginally better with PCA is the LumB subtype. In our case, PCA likely only helped speed up computation of our clusters, as it doesn't seem to have had any improvement with grouping the subtypes. 
    
    d) Now we have an x patient with breast cancer but with unknown sub-type. We have this patient's mRNA sequencing data. Project this x patient to the space of PC1 and PC2. (Hint: remember we remove some gene with no counts or no variablity, take log and centered) Plot this patient in the plot in iv) with a black dot. Calculate the Euclidean distance between this patient and each of centroid of the cluster. Can you tell which sub-type this patient might have? 
    
```{r}
x_patient <- fread("data/brca_x_patient.csv")
```

We will add this x patient to the graph with a dark red dot to distinguish it from the black dots which represent the cluster centers. 
```{r fig.height=1.8, fig.width=3}
xpat_sub <- x_patient[, keep_cols, with = F]

#log 
xpat_sub <- log2(as.matrix(xpat_sub+1e-10))
xpat_center <- xpat_sub - colMeans(brca_sub)

xpat_pc <- xpat_center %*% svd_ret_unscaled$v[, 1:2]

xpat_plot <- ggplot() +
  geom_point(data = kmeans_table, mapping = aes(x = x, y = y, col = col, shape = cl)) +
  scale_color_manual(labels = c("basal", "Her2", "lumA", "lumB"),
  values = scales::hue_pal()(4)) +
  scale_shape_manual(labels = c("Clulster 1", "Cluster 2", "Cluster 3", "Cluster 4"),
  values = c(4, 16, 6, 5)) +
  labs(color = "Cancer type", shape = "Cluster") +
  xlab("PC1") +
  ylab("PC2") +
  geom_point(mapping = aes_string(x = kmean_ret$centers[, 1], y = kmean_ret$centers[, 2]), color = "black", size = 2) + 
  geom_point(mapping = aes_string(x = xpat_pc[, 1], y = xpat_pc[, 2]), color = "dark red", size = 3)
  theme_bw()

xpat_plot
```
```{r}
apply(kmean_ret$centers, 1, function(x) sqrt((x[1] - xpat_pc[, 1])^2 + (x[2] - xpat_pc[, 2])^2))
```
We can see that the euclidean distance to cluster 1's centroid is 498, to cluster 2's it's 534, to cluster 3's it's 135 and to cluster 4's it's 577. Using these distances we can say that patient x is part of cluster 3, which as discussed before, almost entirely consists of those with basal-like breast cancer. This means the patient might have the subtype of basal-like breast cancer. 

# Case study 3: Auto data set

This question utilizes the `Auto` dataset from ISLR. The original dataset contains 408 observations about cars. It is similar to the CARS dataset that we use in our lectures. To get the data, first install the package ISLR. The `Auto` dataset should be loaded automatically. We'll use this dataset to practice the methods learn so far. 
Original data source is here: https://archive.ics.uci.edu/ml/datasets/auto+mpg


Get familiar with this dataset first. Tip: you can use the command `?ISLR::Auto` to view a description of the dataset. 


## EDA
Explore the data, with particular focus on pairwise plots and summary statistics. Briefly summarize your findings and any peculiarities in the data.

```{r}
names(Auto)
Auto[1:5,]
summary(Auto)
sum(is.na(Auto))
```
Note that there are no NA values in the data set, meaning there are no missing values. 

```{r}
Auto %>% 
  ggplot(aes(x=weight, y=mpg)) +
  geom_point(size = 3, color = "dark green") + 
  labs(title = "Weight of Car vs MPG", 
       x = "Weight", 
       y = "MPG") +
  theme_bw() +
  theme(legend.position = "none")

cor(Auto$weight, Auto$mpg)
```
By looking at the above scatter plot and the correlation between the weight of the car and the MPG, we can said that there is a strong, negative correlation between the two variables, -0.832 is a strong indication that as the weight of the car increases, the MPG will decrease.

```{r}
Auto %>% ggplot() +
  geom_histogram(aes(x = cylinders), bins = 6, fill = "light blue") +
  labs( title = "Histogram of Cylinders", x = "Number of Cylinders" , y = "Frequency")

```
We can see that the majority of the cars have an even number of cylinders. This is likely for efficiency in the balancing of the engine and allowing for symmetry when making the car. 

```{r}
Auto %>% 
  ggplot(aes(x=horsepower, y=acceleration)) +
  geom_point(size = 3, color = "blue") + 
  labs(title = "Horsepower vs. Acceleration", 
       x = "Horsepower", 
       y = "Acceleration") +
  theme_bw() +
  theme(legend.position = "none")

cor(Auto$horsepower, Auto$acceleration)
```
From the above graph and the correlation between horsepower and acceleration, we can see that as the horsepower for a car increases, the acceleration decreases. 

```{r}
Auto %>%
  ggplot(aes(x = year, y = mpg, group = year, fill = year)) + 
  geom_boxplot() +
  xlab("Year") +
  ylab("MPG") +
  ggtitle("MPG by Year") + 
  theme(legend.position = "none",
        # adjust for margins around the plot; t: top; r: right; b: bottom; l: left
        plot.margin = margin(t = 5, r = 50, b = 5, l = 0, unit = "pt"), 
        axis.text.x = element_text(angle = -60, vjust = 0, hjust = 0))

```

Although there are years where the median MPG of all the cars decreases, in general as the years go by there is an increase in MPG of the cars. This could be due to new developments in technology and inventions and innovations. 


## What effect does `time` have on `MPG`?

a) Start with a simple regression of `mpg` vs. `year` and report R's `summary` output. Is `year` a significant variable at the .05 level? State what effect `year` has on `mpg`, if any, according to this model. 

```{r}
auto.fit <- lm(mpg~year, data = Auto)
summary(auto.fit)
```
**Answer:** At the 0.05 level, we can see that year is a significant variable, as the p-value is <2e-16 and that is significantly less than 0.05. This means that we would reject the null hypothesis that $\beta_{year} = 0$. Thus we get that year has some effect on MPG. According to this model, as the year increases by one, we see that MPG increases by 1.23 mpg. 


b) Add `horsepower` on top of the variable `year` to your linear model. Is `year` still a significant variable at the .05 level? Give a precise interpretation of the `year`'s effect found here. 

```{r}
auto.fit2 <- lm(mpg~year+horsepower, data = Auto)
summary(auto.fit2)
```
**Answer:** At the 0.05 level, we can see that year is a significant variable, as the p-value is <2e-16 and that is significantly less than 0.05. This means that we would reject the null hypothesis that $\beta_{year} = 0$. 

According to this model, holding horsepower constant, as the year increases by one, we see that MPG increases by 0.65727 mpg. 


c) The two 95% CI's for the coefficient of year differ among (i) and (ii). How would you explain the difference to a non-statistician?


d) Create a model with interaction by fitting `lm(mpg ~ year * horsepower)`. Is the interaction effect significant at .05 level? Explain the year effect (if any). 

## Categorical predictors

Remember that the same variable can play different roles! Take a quick look at the variable `cylinders`, and try to use this variable in the following analyses wisely. We all agree that a larger number of cylinders will lower mpg. However, we can interpret `cylinders` as either a continuous (numeric) variable or a categorical variable.

a) Fit a model that treats `cylinders` as a continuous/numeric variable. Is `cylinders` significant at the 0.01 level? What effect does `cylinders` play in this model?

b) Fit a model that treats `cylinders` as a categorical/factor. Is `cylinders` significant at the .01 level? What is the effect of `cylinders` in this model? Describe the `cylinders` effect over `mpg`. 

c) What are the fundamental differences between treating `cylinders` as a continuous and categorical variable in your models? 

d) Can you test the null hypothesis: fit0: `mpg` is linear in `cylinders` vs. fit1: `mpg` relates to `cylinders` as a categorical variable at .01 level?  


## Results

Final modeling question: we want to explore the effects of each feature as best as possible. You may explore interactions, feature transformations, higher order terms, or other strategies within reason. The model(s) should be as parsimonious (simple) as possible unless the gain in accuracy is significant from your point of view.
  
a) Describe the final model. Include diagnostic plots with particular focus on the model residuals and diagnoses.

b) Summarize the effects found.

c) Predict the `mpg` of the following car: A red car built in the US in 1983 that is 180 inches long, has eight cylinders, displaces 350 cu. inches, weighs 4000 pounds, and has a horsepower of 260. Also give a 95% CI for your prediction.

