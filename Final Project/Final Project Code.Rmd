---
title: "Final Project"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,warning = FALSE, fig.width = 7, fig.height = 4)
if(!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr, ggplot2, glmnet, car, data.table, GGally, leaps, gglasso, ggpubr, gridExtra, pROC, tidyverse, dplyr, skimr, factoextra, corrplot, tm, wordcloud, tree, rpart, randomForest, ranger, rattle, pROC, partykit, lda, ISLR)
```

# Executive Summary

Each row represents a movie available on FilmTV.it, with the original title, year, genre, duration, country, director, actors, average vote and votes.
The fie in the English version contains 37,711 movies and 19 attributes.

(we should add what each of the different variables mean)

# EDA
```{r}
film <- read.csv("filmtv_movies - ENG.csv")
```

```{r, echo=FALSE, results=FALSE}
summary(film)
```

## Data Cleaning
The first step in our data cleaning is to deal with missing values. First, there werre 88 movies that had no genre. So we used Google to fill in the missing genres to ensure we could use those data points for our analysis. We also were able to find one movie that had no title, however, from the description we were able to determine the movie name as well as the genre. 
```{r, echo=FALSE, results=FALSE}
#there are 88 with no genre, we used Google to determine the genres of the movies
film[film$genre=="",]

film$genre[film$title == "Monsieur Batignole"] <- "Comedy"
film$genre[film$title == "Il posto dell'anima"] <- "Romantic"
film$genre[film$title == "Yossi & Jagger"] <- "Drama"
film$genre[film$title == "Cradle Will Rock"] <- "Drama"
film$genre[film$title == "Bord de mer"] <- "Drama"
film$genre[film$title == "Liberi"] <- "Action"
film$genre[film$title == "SubUrbia"] <- "Comedy"
film$genre[film$title == "It's a Very Merry Muppet Christmas Movie"] <- "Comedy"
film$genre[film$title == "L'autre"] <- "Comedy"
film$genre[film$title == "Nan va koutcheh/Zang-e tafrih/Dow rahehal baraye yek massaleh/Hamsarayan"] <- "Drama"
film$genre[film$title == "Une visite au Louvre"] <- "Documentary"
film$genre[film$title == "Wiesele"] <- "Drama"
film$genre[film$title == "König, Dame, Bube"] <- "Comedy"
film$genre[film$title == "Dokfa nai meuman"] <- "Documentary"
film$genre[film$title == "The Station Agent"] <- "Comedy"
film$genre[film$title == "Marija, krest'janskaja elegija"] <- "Drama"
film$genre[film$title == "Elegija Rossii"] <- "Drama"
film$genre[film$title == "Povinnost'"] <- "Documentary"
film$genre[film$title == "Smirennaja zizn'"] <- "Documentary"
film$genre[film$title == "Beautiful"] <- "Comedy"
film$genre[film$title == "The Muppets' Wizard of Oz"] <- "Comedy"
film$genre[film$title == "L'ingorgo - Una storia impossibile"] <- "Drama"
film$genre[film$title == "Pumhaeng zero"] <- "Romance"
film$genre[film$title == "Julian Po"] <- "Romance"
film$genre[film$title == "En la ciudad de Sylvia"] <- "Romance"
film$genre[film$title == "A vot' bon coeur"] <- "Comedy"
film$genre[film$title == "L'Immoralità"] <- "Thriller"
film$genre[film$title == "Cicciabomba"] <- "Comedy"
film$genre[film$title == "Homeless to Harvard: The Liz Murray Story"] <- "Drama"
film$genre[film$title == "Chaharshanbe-soori"] <- "Drama"
film$genre[film$title == "De la guerre"] <- "Comedy"
film$genre[film$title == "Elizabeth I"] <- "Drama"
film$genre[film$title == "35 rhums"] <- "Drama"
film$genre[film$title == "Ted Bundy"] <- "Crime"
film$genre[film$title == "Tatarak"] <- "Drama"
film$genre[film$title == "Ander"] <- "Romance"
film$genre[film$title == "Star Wars: Episode -1. As Clone pass by"] <- "Adventure"
film$genre[film$title == "La casa sperduta nel parco"] <- "Thriller"
film$genre[film$title == "Rivelazioni di uno psichiatra sul mondo perverso del sesso"] <- "Drama"
film$genre[film$title == "Kill Gil - Vol. 2"] <- "Documentary"
film$genre[film$title == "Plan B"] <- "Comedy"
film$genre[film$title == "Bancs publics (Versailles rive droite)"] <- "Comedy"
film$genre[film$title == "Get Low"] <- "Drama"
film$genre[film$title == "Love"] <- "Romance"
film$genre[film$title == "Kosmos"] <- "Comedy"
film$genre[film$title == "L'arroseur arrosé"] <- "Comedy"
film$genre[film$title == "La distrazione"] <- "Documentary"
film$genre[film$filmtv_id == 42646] <- "Documentary"
film$genre[film$title == "Zift"] <- "Thriller"
film$genre[film$title == "Vacanze col gangster"] <- "Comedy"
film$genre[film$filmtv_id == 43546] <- "Action"
film$genre[film$title == "Almanya - Willkommen in Deutschland"] <- "Comedy"
film$genre[film$title == "V Subbotu"] <- "Drama"
film$genre[film$title == "The Deal"] <- "Romance"
film$genre[film$title == "Fear City"] <- "Drama"
film$genre[film$title == "Gasu ningen dai ichigo"] <- "Fantasy"
film$genre[film$title == "Morte all'orecchio di Van Gogh"] <- "Documentary"
film$genre[film$title == "Fractions of Temporary Periods"] <- "Drama"
film$genre[film$title == "Questo film è dedicato a David Riesman e si intitolerà Capolavoro"] <- "Documentary"
film$genre[film$title == "Il ponte dei sospiri"] <- "Drama"
film$genre[film$title == "La gerla di papà Martin"] <- "Drama"
film$genre[film$title == "Walter Chiari - Fino all'ultima risata"] <- "Documentary"
film$genre[film$title == "Materiale resistente"] <- "Documentary"
film$genre[film$title == "Il prigioniero di Santa Cruz"] <- "Drama"
film$genre[film$title == "Kabe no naka no himegoto"] <- "Drama"
film$genre[film$title == "Amor Louco"] <- "Romance"
film$genre[film$title == "Una iena in cassaforte"] <- "Crime"
film$genre[film$title == "Amish Grace"] <- "Drama"
film$genre[film$title == "Il circolo Pickwick"] <- "Comedy"
film$genre[film$title == "Ties That Bind"] <- "Crime"
film$genre[film$title == "Oliveira, o arquitecto"] <- "Documentary"
film$genre[film$title == "The Adventures of Sherlock Holmes"] <- "Drama"
film$genre[film$title == "Jackass: The Lost Tapes"] <- "Action"
film$genre[film$title == "Sedia elettrica"] <- "Thriller"
film$genre[film$title == "Wrong Cops"] <- "Comedy"
film$genre[film$title == "Educação Sentimental"] <- "Romance"
film$genre[film$title == "Mia moglie, un corpo per l'amore"] <- "Drama"
film$genre[film$title == "Xi You"] <- "Adventure"
film$genre[film$title == "Kreditis Limiti"] <- "Drama"
film$genre[film$title == "Come quando fuori piove"] <- "Comedy"
film$genre[film$title == "Incontro"] <- "Romance"
film$genre[film$title == "Lo scialo"] <- "Romance"
film$genre[film$title == "Mon Mon Mon Monsters"] <- "Thriller"
film$genre[film$title == "The Farm"] <- "Horror"
film$genre[film$title == "All the Colors of Giallo"] <- "Horror"
film$genre[film$title == "Night School"] <- "Horror"
film$genre[film$title == "Tensión sexual, Volumen 1: Volátil"] <- "Drama"

film$title[film$filmtv_id == 47741] <- "Cry of a Prostitute"
film$genre[film$filmtv_id == 47741] <- "Crime"

```
Another thing we noticed when analyzing the data was that some of the genres overlapped. For instance, there was a level "Romantic" and "Romance". We decided that these are essentially the same thing and thus should be marked as the same. 

```{r}
film$genre[film$genre == "Romantic"] <- "Romance"
```




Here we are making film into a factor as it contains categorical variables that would be better analyzed as factors.
```{r}
#make genre into a factor
film$genre <- as.factor(film$genre)
levels(film$genre)
```

We will also make the year variable into different subsections including different years that will be used as a factor. We are going to make the years in sections of 10 years from 1897 to 2021, that will give us 14 different levels of year modulos to work with
```{r}
film$year_mod <- NA
summary(film$year)
film$year_mod[film$year < 1900] <- "[1890,1900)"
film$year_mod[film$year > 1899 & film$year < 1910] <- "[1900,1910)"
film$year_mod[film$year > 1909 & film$year < 1920] <- "[1910,1920)"
film$year_mod[film$year > 1919 & film$year < 1930] <- "[1920,1930)"
film$year_mod[film$year > 1929 & film$year < 1940] <- "[1930,1940)"
film$year_mod[film$year > 1939 & film$year < 1950] <- "[1940,1950)"
film$year_mod[film$year > 1949 & film$year < 1960] <- "[1950,1960)"
film$year_mod[film$year > 1959 & film$year < 1970] <- "[1960,1970)"
film$year_mod[film$year > 1969 & film$year < 1980] <- "[1970,1980)"
film$year_mod[film$year > 1979 & film$year < 1990] <- "[1980,1990)"
film$year_mod[film$year > 1989 & film$year < 2000] <- "[1990,2000)"
film$year_mod[film$year > 1999 & film$year < 2010] <- "[2000,2010)"
film$year_mod[film$year > 2009 & film$year < 2020] <- "[2010,2020)"
film$year_mod[film$year > 2019 & film$year < 2030] <- "[2020,2030)"

film$year_mod <- as.factor(film$year_mod)
summary(film$year_mod)
```


```{r}
#here we want to make sure we save the data to a new csv since we have to submit the cleaned data as well as the old data
```


## Plots and Charts

```{r}
table(film$genre)
```

```{r}
p1 <- ggplot(film) + 
  geom_histogram(aes(x = avg_vote), bins = 10, fill = "light blue") +
  labs( title = "Histogram of Average Vote", x = "Average Vote" , y = "Frequency")

p2 <- ggplot(subset(film, duration < 300)) + 
  geom_histogram(aes(x = duration), bins = 10, fill = " blue") +
  labs( title = "Histogram of Movie Length (for those less than 300 minutes)", x = "Length of Movie (minutes)" , y = "Frequency")

grid.arrange(p1,p2,ncol=2)
```


```{r}
p3 <- ggplot(film) + 
  geom_histogram(aes(x = year), bins = 10, fill = "light green") +
  labs( title = "Histogram of Movie Release Year", x = "Year" , y = "Frequency")

p4 <- ggplot(film) + 
  geom_histogram(aes(x = humor), bins = 5, fill = "red") +
  labs( title = "Histogram of Humor", x = "Humor" , y = "Frequency")

grid.arrange(p3,p4,ncol=2)
```


```{r}
p5 <- ggplot(film) + 
  geom_histogram(aes(x = rhythm), bins = 5, fill = "pink") +
  labs( title = "Histogram of Rhythm", x = "Rhythm" , y = "Frequency")

p6 <- ggplot(film) + 
  geom_histogram(aes(x = effort), bins = 5, fill = "orange") +
  labs( title = "Histogram of Effort", x = "Effort" , y = "Frequency")

grid.arrange(p5,p6,ncol=2)
```


```{r}
p7 <- ggplot(film) + 
  geom_histogram(aes(x = tension), bins = 5, fill = "purple") +
  labs( title = "Histogram of Tension", x = "Tension" , y = "Frequency")

p8 <- ggplot(film) + 
  geom_histogram(aes(x = erotism), bins = 5, fill = "maroon") +
  labs( title = "Histogram of Erotism", x = "Erotism" , y = "Frequency")

grid.arrange(p7,p8,ncol=2)
```

Let's look at the correlation between some of the numerical variables and average vote. 

```{r, warning=FALSE}
film %>%
  select(avg_vote, duration, critics_vote, public_vote) %>%
  ggpairs()
```

In our data we noticed that there are three different voting variables. Our ultimate goal is to predict the average vote, so we want to determine if the public vote and critics vote have a linear relationship or high correlation to the average vote. If that is the case, we will remove those variables from the regression as they have a somewhat linear dependency on one another. 
```{r}
plot(film$avg_vote, film$critics_vote)
abline(lm(avg_vote~critics_vote, film))
```
We can see that the scatter plot shows a high correlation between the average vote and the critics vote with a correlation of 0.915. Thus there is almost a linear relationship between the variables so we will remove critics vote for the sake of prediction and regression. 

```{r}
plot(film$avg_vote, film$public_vote)
abline(lm(avg_vote~public_vote, film))
```
We can see that this scatter plot also shows a high correlation between the average vote and the public vote with a correlation of 0.891. Thus there is almost a linear relationship between the variables so we will remove public vote for the sake of prediction and regression as well. 


# PCA
Let's create PCA scores for our data set and see if they tell us anything important. Since PCA can only be applied on continuous variables, we first remove all non numeric columns.

```{r}
#only selecting numeric columns
film_numeric <- film %>% dplyr::select(where(is.numeric))
```

We also drop the `year` variable because that acts more as a factor variable than a continuous one. The variable `filmtv_id` is not useful for our PCA analysis so we drop that variable. `critics_vote` and `public_vote` are dropped as well as indicated previously. We decided to also remove `duration` and `total_votes`, only leaving the variables that were numeric scores given to the movie.

```{r}
film_numeric2 <- film_numeric[,-c(1,2,3,5,6,7)]
```

Now `film_numeric2` has only numeric vote variables of scores given to the movie and is ready to be put through a PCA analysis.

```{r}
film_pc <- prcomp(film_numeric2, scale=TRUE)
film_pc
```

From the PCA table, since the loadings are all the same sign for PC1, this tells us that PC1 is a weighted average of all the variables. In PC1, `rhythm` has that largest weight while `avg_vote` has the lowest. A higher PC1 implies that the movie has higher numeric scores given to it.

PC2 has loadings with different signs. The loadings for `avg_vote`, `effort`, and `tension` are positive while `humor`, `rhythm`, and `erotism` are negative. A higher PC2 score implies larger `avg_vote`, `effort`, and/or `tension` scores and a lower PC2 score implies larger `humor`, `rhythm`, and/or `erotism` scores.

## PVE

We then look at the Proportion of Variance Explained (PVE) and the scree plot to see how many PC's would be informative enough.

```{r}
plot(film_pc)
plot(summary(film_pc)$importance[2, ],  # PVE
  ylab="PVE",
  xlab="Number of PC's",
  pch = 16, 
  main="Scree Plot of PVE for Film")
```

From the scree plot and using elbow rule, there is a sharp drop at 2 PCs which indicates that taking 2 leading PCs should be enough.

## PC and Genre Clustering

We plot the 2 leading PCs color coding with genre to see if there are any clusters.

```{r}
as.data.frame(film_pc$x) %>%
  mutate(genre = film$genre) %>%
  ggplot(aes(x = PC1, y = PC2)) +  # pca.all$rotation  try PC3 vs. PC1, no gender effect
  geom_point(aes(color = genre)) +
  geom_vline(xintercept = 0) +
  geom_hline(yintercept = 0) +
  ggtitle("PCs with Genre") +
  theme_bw() 
```

The colors in the graphs are pretty well spread out. However, one clear cluster is that the `comedy` genre has lower PC2 scores. This is not surprising considering the loadings for PC2 is largely negative for the humor variable.

We understand and acknowledge that this PCA analysis excludes non numeric variables that could be significant to our overall analysis. This PCA analysis is a start but we continue to do more in depth analysis including non numeric variables.

# Linear Regression

Let's try to predict the average vote using some of the other variables in the data set. First, we will drop some of the variables in the data set that are not useful for the regression, such as `filmtv_id`,`year`, `title`,`country`, `directors`, `actors`, `description`, and `notes`. We will also remove `critics_vote` and `public_vote` as indicated previously. 

```{r}
film2 <- film[,-c(1,2,3,6,7,8,10,11,13,14)]
```

## Simple Regression

First let's start with a linear regression to determine what is the best model fro predicting the average vote. Specifically, let's determine if we can use `genre` to predict what the average vote is. We also can note that `genre` is a categorical/factor variable. We decided to start with `genre` as many people give different reviews based on the genres they like, thus we decided it could be significant in predicting the average vote the movie received. 

```{r}
fit1 <- lm(avg_vote~genre, film2)
#we need this output, or potentially could go in the appendix
summary(fit1)
Anova(fit1)
```
From the summary, we can first not that the genre "Action" is the base for the factor and is represented by the intercept. We can also see that the majority of the different genres are significant in predicting the average vote. We can see that most of the genres increase the average vote given we are only looking at the affect that genre has on the average score. There were however a few genres that decreased the average score, those being biblical, mythology, and romance. 

Further, from the summary of fit1 we can see that some of the specific genres are not significant in predicting the average vote. We see that the genres Biblical and Sport are not significant at a level of 0.1 or less. In fact, their p-values are quite large. Looking at the ANOVA, however, we can see that `genre` as a whole is significant in predicting the average vote, as it's p-value is 2.2e-16. Because of the ANOVA, we can conclude that `genre` is a signicant variable in predicting the average vote and thus we will continue to use it in our analysis. 

##Multiple Regression
Let's continue with genre, and add another variable to see if anything with the model changes. First, let's add on the variable `duration`. We decided to add duration as the next variable since the length of different movies also could be important to people reviewing the movies. For instance, a longer movie may loose the attention of some of the viewers and thus receive a lower score. 

```{r}
fit2 <- lm(avg_vote~genre + duration, film2)
summary(fit2)
Anova(fit2)
```
From the summary, we can see that holding the genre constant, the duration is significant in predicting the average vote. Further, holding the duration constant, the genres that decrease the average vote are the same from the single regression, those being biblical, mythology, and romance. 

Once again, the summary reveals that some of the specific genres are not significant at a significance level of 0.1, those being Biblical, Short Movie, and Sport. However, we can see that the majority of the genres have very low p-values, < 2.2e-16. And, in viewing the ANOVA, we can see that both duration, and genre as a whole are significant in predicting the average vote. 

Let's run a linear model using all of the variables
```{r}
fit.full <- lm(avg_vote~.,film2)
Anova(fit.full)
summary(fit.full)
```
Based on the ANOVA for this test, we can see that all of the variables used the the regression are significant. 

Looking at the summary, we can see the importance of some of the specific variables and levels of the factors. From the summary, we can see that only about half of the specific genres are considered significant. This is different than what we saw with the simple regression and the multiple regression using just two variables. Further, from the summary we can also see that none of the specific year modules are significant either. Thus we will continue with determining a model, using backwards elimination to remove the `year_mod` and see if our model is better at prediction. 

```{r}
fit3 <-lm(avg_vote~. -year_mod, film2)
summary(fit3)
Anova(fit3)
```
Based on the summary, we can see that in fit3 more of the specific genres are significant and from the ANOVA we can see that are of the variables are significant. Now we can compare the two models, fit.full and fit3, to determine if there is significant difference. 

```{r}
anova(fit.full, fit3)
```
From the analysis of variance comparing the two models we see that there is a significant difference between the two models, as the p-value is < 2.2e-16. Thus we will decided that fit3 that doesn't include the `year_mod` will be the model we continue on with. This allows for our model to be slightly simpler as well as we have fewer variables to manage, especially since `year_mod` is factor with numerous levels. 

Now we want to check out linear model assumptions for fit3. 

```{r}
par(mfrow=c(1,2))
plot(fit3, 1) 
plot(fit3, 2)
```
Here we see that the normality assumption is met as the normal qq plot follows the line $y=x$ approximately. We can see that the first plot, meets the homoscedasticity requirement. 


# Trees

We now build tree models to predict the average rating.

```{r}
film_tree <- tree(avg_vote~., film2)

plot(film_tree)
title(main =  "final single tree")
text(film_tree, pretty=0)
```



# Logistic Regression

Now let's use our data to perform a Logistic Regression to determine whether the movie is good or bad. We will use the average vote numbers to make a binary variable that is 1 if the rating is greater than 6, and 0 otherwise.
```{r}
film3 <- film2
film3$rating <- ifelse(film3$avg_vote > 6 , "1", "0")
film3$rating <- as.integer(film3$rating)
table(film2$rating)
#add a jitter plot
```

Now we want to split up our data in testing and training.

# Text Analysis 

## Description EDA
```{r, echo = FALSE, results = FALSE}
desc_text <- film$description
corpus <- VCorpus(VectorSource(desc_text))

# Converts all words to lowercase
corpus_clean <- tm_map(corpus, content_transformer(tolower))

# Removes common English stopwords (e.g. "with", "i")
corpus_clean <- tm_map(corpus_clean, removeWords, stopwords("english"))

corpus_clean <- tm_map(corpus_clean, removePunctuation)

# Removes numbers
corpus_clean <- tm_map(corpus_clean, removeNumbers)

# Stem words
corpus_clean <- tm_map(corpus_clean, stemDocument, lazy = TRUE)

dtm <- DocumentTermMatrix(corpus_clean)
dtms <- removeSparseTerms(dtm, 0.995)
```

```{r, echo = FALSE, fig.width = 3, fig.height = 3, warning=FALSE}
total_freq <- sort(colSums(as.matrix(dtms)), decreasing = TRUE)
cor.special <- brewer.pal(8, "Dark2")
wordcloud(names(total_freq)[1:100], total_freq[1:100], colors=cor.special, ordered.colors=F)
```


