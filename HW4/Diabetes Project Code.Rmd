---
title: "Predicting readmission probability for diabetes inpatients"
author: 
- Annie Vo
- Sarah Hayward
- Jessica Brown
date: ' '
output:
  pdf_document:
    toc: yes
    toc_depth: '4'
  html_document:
    code_folding: show
    highlight: haddock
    theme: lumen
    toc: yes
    toc_depth: 4
    toc_float: yes
  word_document:
    toc: yes
    toc_depth: '4'
urlcolor: blue
---

* to hide source code: echo = FALSE
* to hide text output: results = 'hide' or results = FALSE
* hide messages: message = FALSE
* hide warning messages: warning = FALSE
* hide plotsL fig.show = 'hide'

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.width = 7, fig.height = 4)
if(!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr, ggplot2, glmnet, car, data.table, GGally, leaps, gglasso)   #add your packages here
```

# Executive Summary 

# Data Summary / EDA
* Nature of the data, origin
* Necessary quantitative and graphical summaries
* Are there any problems with the data?
* Which variables are considered as input 


```{r, echo=FALSE, results=FALSE}
diabetes <- read.csv("diabetic.data.csv")
names(diabetes)
```


```{r, results = FALSE}
readmission <- read.csv("readmission.csv")
head(readmission)
summary(readmission)
names(readmission)
```

Let's look at what other variables should be factors
```{r, results = FALSE}
readmission$race <- as.factor(readmission$race)
```
```{r,results = FALSE}
readmission$gender <- as.factor(readmission$gender)
```


The original data is from the [Center for Clinical and Translational Research](https://archive.ics.uci.edu/ml/datasets/Diabetes+130-US+hospitals+for+years+1999-2008) at Virginia Commonwealth University. It covers data on diabetes patients across 130 U.S. hospitals from 1999 to 2008. There are over 100,000 unique hospital admissions in this dataset, from ~70,000 unique patients. The data includes demographic elements, such as age, gender, and race, as well as clinical attributes such as tests conducted, emergency/inpatient visits, etc.

For our analysis we will use a cleaned subset of this dataset which excludes variables with lots of missing values and variables with very little variability, as well as applying binning on some categorical variables. 

The event of interest is **readmitted within < 30 days**. 

```{r,results = FALSE}
#create response variable for readmit within <30 days
readmission$lessThanThirty <- ifelse(readmission$readmitted == "<30", 1, 0)
sum(readmission$lessThanThirty)
```

TURN INTO 2 SIDE BY SIDE SUBPLOTS:
```{r}
ggplot(readmission, aes(x = factor(gender), fill = gender)) +
  geom_bar(stat = "count", width = 0.7, color = "black") + 
  scale_fill_brewer(palette="Greens") + 
  xlab("gender") +
  ggtitle("Distribution of Gender in Cleaned Dataset") + 
  theme_minimal()
```

```{r}
ggplot(readmission, aes(x = factor(lessThanThirty), fill = gender)) +
  geom_bar(stat = "count", width = 0.7, position = position_dodge(), color = "black") + 
  scale_fill_brewer(palette="Greens") + 
  xlab("Readmitted Within <30 Days") +
  ggtitle("Distribution of Gender with Response Variable") +
  theme_minimal()
```

```{r}
ggplot(readmission, aes(x = factor(race), fill = race)) +
  geom_bar(stat = "count", width = 0.7, color = "black") + 
  scale_fill_brewer(palette="Reds") + 
  xlab("race") +
  ggtitle("Distribution of Race in Cleaned Dataset") + 
  theme_minimal()
```

```{r}
ggplot(readmission, aes(x = factor(lessThanThirty), fill = race)) +
  geom_bar(stat = "count", width = 0.7, color = "black") + 
  scale_fill_brewer(palette="Reds") + 
  xlab("Readmitted Within <30 Days") +
  ggtitle("Distribution of Race with Response Variable") +
  theme_minimal()
```

```{r}
ggplot(readmission, aes(x = factor(age_mod), fill = age_mod)) +
  geom_bar(stat = "count", width = 0.7, color = "black") + 
  scale_fill_brewer(palette="Blues") + 
  labs(title = "Distribution of Age in Cleaned Dataset", fill = "Age group", x = "Age group") + 
  theme_minimal()
```

```{r}
ggplot(readmission, aes(x = factor(age_mod), fill = gender)) +
  geom_bar(stat = "count", width = 0.7, color = "black", position = position_dodge()) + 
  scale_fill_brewer(palette="Greens") + 
  labs(title = "Distribution of Gender for Each Age Group", fill = "Gender", x = "Age group") + 
  theme_minimal()
```
```{r}
ggplot(readmission, aes(x = num_medications)) +
  geom_boxplot() + 
  labs(x = "Number of Medications", title = "Distribution of Number of Medications") + 
  theme_minimal()
```

Which variables? 
```{r}
readmission_sub <- readmission %>% select(-encounter_id, -patient_nbr, -readmitted)
```

```{r}
readmission_sub %>% filter((gender == "Unknown/Invalid") | (race == "?"))
```

```{r}
readmission_sub <- readmission_sub %>% filter((race != "?") & (gender != "Unknown/Invalid") & (diag3_mod != "?"))
readmission_sub <- droplevels(readmission_sub)
#lapply(readmission_sub, unique)
```

```{r}
X <- model.matrix(lessThanThirty~., readmission_sub)[,-1]
dim(X)
```

```{r}
Y <- readmission_sub$lessThanThirty
```

```{r}
#takes a while to run
set.seed(10)
fit1.cv <- cv.glmnet(X, Y,  alpha=1, family="binomial", nfolds = 10, type.measure = "deviance")
plot(fit1.cv)
```

```{r}
coef.1se <- coef(fit1.cv, s="lambda.1se")
coef.1se <- coef.1se[which(coef.1se !=0),]
coef.1se
```

```{r}
rownames(as.matrix(coef.1se))
```

```{r}
coef.min <- coef(fit1.cv, s="lambda.min")
coef.min <- coef.min[which(coef.min !=0), ]
as.matrix(coef.min)
```

```{r}
beta.min <- rownames(as.matrix(coef.min))
beta.min
```

```{r}
model.1 <- glm(lessThanThirty~ race + time_in_hospital + num_lab_procedures + num_procedures + num_medications + number_outpatient + number_emergency + number_inpatient + number_diagnoses + max_glu_serum + A1Cresult + metformin + glimepiride + glipizide + glyburide + pioglitazone + rosiglitazone + insulin + change + diabetesMed + disch_disp_modified + adm_src_mod + age_mod + diag1_mod + diag2_mod + diag3_mod, family=binomial, data = readmission_sub)
```

```{r}
#summary(model.1)

#also takes a very long time
Anova(model.1)
```

```{r}
model.2 <- glm(lessThanThirty~ num_procedures + num_medications + number_emergency + number_inpatient + number_diagnoses + A1Cresult + metformin + glipizide + insulin + diabetesMed + disch_disp_modified + adm_src_mod + age_mod + diag1_mod + diag2_mod + diag3_mod, family=binomial, data = readmission_sub)

anova(model.2, model.1, test = "Chisq")
```

```{r}
# sooooo loooooong
Anova(model.2)
```

```{r}
# group LASSO
Y <- (-1)*(Y == 0) + (1)*(Y == 1)

categoricals <- c("race", "gender", "max_glu_serum", "A1Cresult", "metformin", "glimepiride", "glipizide", "glyburide", "pioglitazone", "rosiglitazone", "insulin", "change", "diabetesMed", "disch_disp_modified", "adm_src_mod", "adm_typ_mod", "age_mod", "diag1_mod", "diag2_mod", "diag3_mod")
readmission_sub[categoricals] <- lapply(readmission_sub[categoricals], as.factor)

group1 = NULL
for (i in 1:28) {
  if (is.factor(readmission_sub[,i])) {
    num_level = nlevels(readmission_sub[,i])
    group1 = c(group1, rep(i, num_level - 1))
  } else group1 = c(group1, i)
}
length(group1)
```

```{r}
#cv_glasso <- cv.gglasso(x = X, y = Y, group=group1, loss="logit", pred.loss="misclass", nfolds=10)
#names(cv_glasso)
#plot(cv_glasso)
```



# Analysis 
* Various appropriate statistical methods: e.g. glmnet 
* Comparisons various models
* Final model(s)

# Conclusion
* Summarize results and the final model
* Final recommendations

# Appendix
* Any thing necessary to keep but for which you donâ€™t want them to be in the main report
* Use Appendices to display lengthy output. 


